
blueprint:
  name: Alerta de Janela Aberta na Chuva
  description: >
    Envia uma notifica√ß√£o se come√ßar a chover e qualquer uma das
    janelas ou portas monitoradas estiver aberta.

    A notifica√ß√£o lista exatamente quais janelas est√£o abertas.
  domain: automation

  input:
    rain_sensor:
      name: (Obrigat√≥rio) Sensor de Chuva
      description: A entidade (binary_sensor) que muda para 'on' quando est√° chovendo.
      selector:
        entity:
          domain: binary_sensor

    window_sensors:
      name: (Obrigat√≥rio) Sensores de Janela/Porta
      description: Selecione todas as janelas ou portas que devem ser monitoradas.
      selector:
        entity:
          domain: binary_sensor
          device_class: 
            - door
            - window
          multiple: true

    notify_service:
      name: (Obrigat√≥rio) Servi√ßo de Notifica√ß√£o
      description: >
        Selecione o servi√ßo para enviar a notifica√ß√£o 
        (ex: notify.mobile_app_seu_celular ou um grupo notify).
      selector:
        service:    # <-- Este √© o seletor correto para sua vers√£o
          domain: notify

    message_title:
      name: (Opcional) T√≠tulo da Notifica√ß√£o
      description: O t√≠tulo da mensagem de notifica√ß√£o.
      default: "üåßÔ∏è ALERTA DE CHUVA! üåßÔ∏è"
      selector:
        text:

    message_body:
      name: (Opcional) Corpo da Mensagem
      description: >
        O texto da notifica√ß√£o. Use a vari√°vel '{janelas_abertas}'
        para listar as janelas.
      default: "Est√° chovendo e as seguintes janelas est√£o abertas: {janelas_abertas}."
      selector:
        text:

mode: single
max_exceeded: silent

variables:
  lista_sensores_janelas: !input window_sensors

trigger:
  - platform: state
    entity_id: !input rain_sensor
    to: 'on'

condition:
  - condition: template
    value_template: >
      {{ expand(lista_sensores_janelas) | selectattr('state', 'eq', 'on') | list | count > 0 }}

action:
  - variables:
      janelas_abertas: >
        {{ expand(lista_sensores_janelas) 
           | selectattr('state', 'eq', 'on')
           | map(attribute='name') 
           | list 
           | join(', ') }}

  - service: !input notify_service
    data:
      title: !input message_title
      message: >
        {{ !input message_body | replace('{janelas_abertas}', janelas_abertas) }}
