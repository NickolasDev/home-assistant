blueprint:
  name: Alerta Inteligente de Janela Aberta na Chuva (2025)
  description: >
    Sistema avanÃ§ado de notificaÃ§Ã£o que alerta quando comeÃ§a a chover e janelas/portas
    estÃ£o abertas. Inclui previsÃ£o de chuva, mÃºltiplos nÃ­veis de alerta, aÃ§Ãµes automÃ¡ticas,
    perÃ­odo de silÃªncio e notificaÃ§Ãµes persistentes com aÃ§Ãµes rÃ¡pidas.
  domain: automation
  
  author: EvoluÃ§Ã£o 2025
  homeassistant:
    min_version: 2024.1.0

  input:
    # ============================================
    # SEÃ‡ÃƒO: SENSORES E MONITORAMENTO
    # ============================================
    rain_sensor:
      name: ğŸŒ§ï¸ Sensor de Chuva Principal
      description: Sensor que detecta quando estÃ¡ chovendo ativamente.
      selector:
        entity:
          domain: binary_sensor
          multiple: false

    rain_forecast:
      name: â›… Sensor de PrevisÃ£o de Chuva (Opcional)
      description: >
        Sensor que prevÃª chuva (ex: weather entity ou sensor customizado).
        Permite alertas preventivos antes da chuva comeÃ§ar.
      default: []
      selector:
        entity:
          domain: 
            - weather
            - binary_sensor
          multiple: false

    window_sensors:
      name: ğŸªŸ Sensores de Janela/Porta
      description: Todas as janelas ou portas que devem ser monitoradas.
      selector:
        entity:
          domain: binary_sensor
          device_class: 
            - door
            - window
            - opening
          multiple: true

    priority_windows:
      name: âš ï¸ Janelas PrioritÃ¡rias (Opcional)
      description: >
        Janelas crÃ­ticas que geram alerta imediato e mais enfÃ¡tico
        (ex: janelas que dÃ£o para Ã¡reas sensÃ­veis).
      default: []
      selector:
        entity:
          domain: binary_sensor
          device_class: 
            - door
            - window
            - opening
          multiple: true

    # ============================================
    # SEÃ‡ÃƒO: NOTIFICAÃ‡Ã•ES
    # ============================================
    notify_service:
      name: ğŸ“± ServiÃ§o de NotificaÃ§Ã£o
      description: >
        ServiÃ§o para enviar notificaÃ§Ãµes (ex: notify.mobile_app_iphone,
        notify.all_devices, notify.familia).
      selector:
        text:

    critical_notification:
      name: ğŸš¨ Usar NotificaÃ§Ã£o CrÃ­tica
      description: >
        Ativa notificaÃ§Ã£o crÃ­tica (ignora modo silencioso no celular) 
        para janelas prioritÃ¡rias.
      default: false
      selector:
        boolean:

    notification_sound:
      name: ğŸ”” Som da NotificaÃ§Ã£o (Opcional)
      description: Nome do arquivo de som personalizado.
      default: ''
      selector:
        text:

    # ============================================
    # SEÃ‡ÃƒO: MENSAGENS PERSONALIZADAS
    # ============================================
    message_title_active:
      name: ğŸ“ TÃ­tulo - Chuva Ativa
      description: TÃ­tulo quando a chuva jÃ¡ comeÃ§ou.
      default: "ğŸŒ§ï¸ ALERTA: Chuva e Janelas Abertas!"
      selector:
        text:

    message_title_forecast:
      name: ğŸ“ TÃ­tulo - PrevisÃ£o de Chuva
      description: TÃ­tulo para alerta preventivo (antes da chuva).
      default: "â›… AVISO: Chuva Prevista e Janelas Abertas"
      selector:
        text:

    message_body:
      name: ğŸ“ Corpo da Mensagem
      description: >
        Texto da notificaÃ§Ã£o. VariÃ¡veis disponÃ­veis:
        {janelas_abertas}, {total}, {prioritarias}, {tempo}
      default: >
        EstÃ¡ chovendo agora! {total} abertura(s) detectada(s): {janelas_abertas}.
        {prioritarias}
        Feche-as imediatamente para evitar danos.
      selector:
        text:
          multiline: true

    # ============================================
    # SEÃ‡ÃƒO: AÃ‡Ã•ES AUTOMÃTICAS
    # ============================================
    auto_close_covers:
      name: ğŸšï¸ Fechar Coberturas Automaticamente
      description: >
        Fecha automaticamente persianas/cortinas elÃ©tricas quando detectar chuva.
      default: []
      selector:
        entity:
          domain: cover
          multiple: true

    turn_off_devices:
      name: ğŸ”Œ Desligar Dispositivos (Opcional)
      description: >
        Dispositivos para desligar automaticamente quando chover
        (ex: ventiladores perto de janelas).
      default: []
      selector:
        entity:
          domain: 
            - switch
            - fan
          multiple: true

    activate_scene:
      name: ğŸ¬ Cena para Ativar (Opcional)
      description: Cena do Home Assistant para executar quando chover.
      default: []
      selector:
        entity:
          domain: scene
          multiple: false

    # ============================================
    # SEÃ‡ÃƒO: COMPORTAMENTO E CONTROLE
    # ============================================
    forecast_advance_time:
      name: â±ï¸ Tempo de AntecedÃªncia (PrevisÃ£o)
      description: >
        Quantos minutos antes da chuva prevista enviar alerta preventivo.
      default: 30
      selector:
        number:
          min: 5
          max: 120
          step: 5
          unit_of_measurement: "minutos"

    repeat_notification:
      name: ğŸ” Repetir NotificaÃ§Ã£o
      description: Enviar notificaÃ§Ãµes repetidas enquanto janelas estiverem abertas.
      default: true
      selector:
        boolean:

    repeat_interval:
      name: â²ï¸ Intervalo de RepetiÃ§Ã£o
      description: Tempo entre notificaÃ§Ãµes repetidas.
      default: 5
      selector:
        number:
          min: 1
          max: 60
          step: 1
          unit_of_measurement: "minutos"

    max_repeats:
      name: ğŸ”¢ MÃ¡ximo de RepetiÃ§Ãµes
      description: NÃºmero mÃ¡ximo de notificaÃ§Ãµes repetidas (0 = ilimitado).
      default: 5
      selector:
        number:
          min: 0
          max: 20
          step: 1

    quiet_hours_enabled:
      name: ğŸŒ™ Ativar PerÃ­odo de SilÃªncio
      description: NÃ£o enviar notificaÃ§Ãµes durante horÃ¡rios especÃ­ficos.
      default: false
      selector:
        boolean:

    quiet_start_time:
      name: ğŸ• InÃ­cio do PerÃ­odo de SilÃªncio
      description: Hora de inÃ­cio (exemplo 22:00).
      default: "22:00:00"
      selector:
        time:

    quiet_end_time:
      name: ğŸ• Fim do PerÃ­odo de SilÃªncio
      description: Hora de tÃ©rmino (exemplo 07:00).
      default: "07:00:00"
      selector:
        time:

    override_quiet_for_priority:
      name: ğŸš¨ Ignorar SilÃªncio para Janelas PrioritÃ¡rias
      description: Enviar notificaÃ§Ãµes de janelas prioritÃ¡rias mesmo no perÃ­odo de silÃªncio.
      default: true
      selector:
        boolean:

    # ============================================
    # SEÃ‡ÃƒO: RECURSOS AVANÃ‡ADOS
    # ============================================
    enable_actionable_notifications:
      name: ğŸ¯ AÃ§Ãµes RÃ¡pidas na NotificaÃ§Ã£o
      description: >
        Adiciona botÃµes na notificaÃ§Ã£o (apenas mobile_app):
        "Fechar Tudo", "Lembrar em 5min", "Ignorar".
      default: true
      selector:
        boolean:

    enable_tts_announcement:
      name: ğŸ”Š AnÃºncio por Voz (TTS)
      description: Fazer anÃºncio de voz em alto-falantes inteligentes.
      default: false
      selector:
        boolean:

    tts_service:
      name: ğŸ—£ï¸ ServiÃ§o TTS
      description: ServiÃ§o de text-to-speech (ex: tts.google_translate_say).
      default: ''
      selector:
        text:

    tts_target:
      name: ğŸ“¢ Dispositivos para TTS
      description: Media players para anÃºncio de voz.
      default: []
      selector:
        entity:
          domain: media_player
          multiple: true

    log_to_logbook:
      name: ğŸ“” Registrar no HistÃ³rico
      description: Criar entrada no logbook do Home Assistant.
      default: true
      selector:
        boolean:

mode: restart
max_exceeded: silent

variables:
  # Listas de sensores
  lista_sensores_janelas: !input window_sensors
  lista_janelas_prioritarias: !input priority_windows
  lista_coberturas: !input auto_close_covers
  lista_dispositivos: !input turn_off_devices
  
  # ConfiguraÃ§Ãµes
  usar_critico: !input critical_notification
  repeticoes_ativas: !input repeat_notification
  intervalo_repeticao: !input repeat_interval
  max_repeticoes: !input max_repeats
  silencio_ativo: !input quiet_hours_enabled
  silencio_inicio: !input quiet_start_time
  silencio_fim: !input quiet_end_time
  ignorar_silencio_prioritarias: !input override_quiet_for_priority
  acoes_ativas: !input enable_actionable_notifications
  tts_ativo: !input enable_tts_announcement
  log_ativo: !input log_to_logbook
  
  # CÃ¡lculo de janelas abertas
  janelas_abertas_lista: >
    {{ expand(lista_sensores_janelas) 
       | selectattr('state', 'eq', 'on')
       | map(attribute='name') 
       | list }}
       
  janelas_prioritarias_abertas: >
    {{ expand(lista_janelas_prioritarias) 
       | selectattr('state', 'eq', 'on')
       | map(attribute='name') 
       | list }}
       
  total_abertas: "{{ janelas_abertas_lista | count }}"
  
  tem_prioritarias: "{{ janelas_prioritarias_abertas | count > 0 }}"
  
  janelas_texto: "{{ janelas_abertas_lista | join(', ') }}"
  
  prioritarias_texto: >
    {% if tem_prioritarias %}
    âš ï¸ ATENÃ‡ÃƒO ESPECIAL: {{ janelas_prioritarias_abertas | join(', ') }}
    {% else %}
    {% endif %}
  
  # Verificar perÃ­odo de silÃªncio
  em_periodo_silencio: >
    {% if silencio_ativo %}
      {{ now().time() >= (silencio_inicio | as_datetime).time() or 
         now().time() <= (silencio_fim | as_datetime).time() }}
    {% else %}
      false
    {% endif %}
    
  deve_notificar: >
    {{ not em_periodo_silencio or 
       (ignorar_silencio_prioritarias and tem_prioritarias) }}

trigger:
  # Trigger 1: Chuva ativa detectada
  - platform: state
    id: chuva_ativa
    entity_id: !input rain_sensor
    to: 'on'
  
  # Trigger 2: PrevisÃ£o de chuva (se configurado)
  - platform: state
    id: chuva_prevista
    entity_id: !input rain_forecast
    to: 
      - 'rainy'
      - 'pouring'
      - 'on'

  # Trigger 3: Janela aberta durante chuva
  - platform: state
    id: janela_aberta
    entity_id: !input window_sensors
    to: 'on'

condition:
  # SÃ³ aciona se houver janelas abertas
  - condition: template
    value_template: "{{ total_abertas | int > 0 }}"
  
  # Verificar se deve notificar (perÃ­odo de silÃªncio)
  - condition: template
    value_template: "{{ deve_notificar }}"
  
  # Confirmar que estÃ¡ chovendo ou vai chover
  - condition: or
    conditions:
      - condition: state
        entity_id: !input rain_sensor
        state: 'on'
      - condition: template
        value_template: >
          {{ states(!input rain_forecast) in ['rainy', 'pouring', 'on'] }}

action:
  # ============================================
  # PASSO 1: AÃ‡Ã•ES AUTOMÃTICAS
  # ============================================
  
  # Fechar coberturas automaticamente
  - if:
      - condition: template
        value_template: "{{ lista_coberturas | count > 0 }}"
    then:
      - service: cover.close_cover
        target:
          entity_id: !input auto_close_covers
      
      - if:
          - condition: template
            value_template: "{{ log_ativo }}"
        then:
          - service: logbook.log
            data:
              name: "ğŸšï¸ AutomaÃ§Ã£o Chuva"
              message: "Coberturas fechadas automaticamente: {{ lista_coberturas | join(', ') }}"

  # Desligar dispositivos
  - if:
      - condition: template
        value_template: "{{ lista_dispositivos | count > 0 }}"
    then:
      - service: homeassistant.turn_off
        target:
          entity_id: !input turn_off_devices

  # Ativar cena
  - if:
      - condition: template
        value_template: "{{ !input activate_scene != [] }}"
    then:
      - service: scene.turn_on
        target:
          entity_id: !input activate_scene

  # ============================================
  # PASSO 2: NOTIFICAÃ‡Ã•ES
  # ============================================
  
  # Preparar dados da notificaÃ§Ã£o
  - variables:
      titulo_notificacao: >
        {% if trigger.id == 'chuva_prevista' %}
          !input message_title_forecast
        {% else %}
          !input message_title_active
        {% endif %}
      
      corpo_notificacao: >
        {{ !input message_body 
           | replace('{janelas_abertas}', janelas_texto)
           | replace('{total}', total_abertas | string)
           | replace('{prioritarias}', prioritarias_texto)
           | replace('{tempo}', now().strftime('%H:%M')) }}
      
      dados_notificacao: >
        {% set data = namespace(dict={}) %}
        {% if usar_critico and tem_prioritarias %}
          {% set data.dict = dict(data.dict, **{'push': {'sound': {'name': 'default', 'critical': 1, 'volume': 1.0}}}) %}
        {% elif !input notification_sound != '' %}
          {% set data.dict = dict(data.dict, **{'push': {'sound': !input notification_sound}}) %}
        {% endif %}
        {% if acoes_ativas %}
          {% set data.dict = dict(data.dict, **{'actions': [
            {'action': 'CLOSE_ALL', 'title': 'Fechar Tudo'},
            {'action': 'SNOOZE_5MIN', 'title': 'Lembrar em 5min'},
            {'action': 'DISMISS', 'title': 'Ignorar'}
          ]}) %}
        {% endif %}
        {{ data.dict }}

  # Enviar notificaÃ§Ã£o principal
  - service: !input notify_service
    data:
      title: "{{ titulo_notificacao }}"
      message: "{{ corpo_notificacao }}"
      data: "{{ dados_notificacao }}"

  # ============================================
  # PASSO 3: TTS (se ativado)
  # ============================================
  
  - if:
      - condition: template
        value_template: "{{ tts_ativo and !input tts_service != '' }}"
    then:
      - service: !input tts_service
        target:
          entity_id: !input tts_target
        data:
          message: >
            AtenÃ§Ã£o! EstÃ¡ chovendo e {{ total_abertas }} janela(s) estÃ¡(Ã£o) aberta(s).
            Por favor, feche: {{ janelas_texto }}.

  # ============================================
  # PASSO 4: LOGBOOK
  # ============================================
  
  - if:
      - condition: template
        value_template: "{{ log_ativo }}"
    then:
      - service: logbook.log
        data:
          name: "ğŸŒ§ï¸ Alerta de Chuva"
          message: >
            Detectada chuva com {{ total_abertas }} abertura(s): {{ janelas_texto }}.
            {% if tem_prioritarias %}Janelas prioritÃ¡rias abertas!{% endif %}
          entity_id: !input rain_sensor

  # ============================================
  # PASSO 5: REPETIÃ‡ÃƒO (se configurado)
  # ============================================
  
  - if:
      - condition: template
        value_template: "{{ repeticoes_ativas }}"
    then:
      - repeat:
          while:
            - condition: template
              value_template: >
                {{ states(!input rain_sensor) == 'on' and
                   expand(lista_sensores_janelas) | selectattr('state', 'eq', 'on') | list | count > 0 and
                   (max_repeticoes == 0 or repeat.index <= max_repeticoes) }}
          sequence:
            - delay:
                minutes: "{{ intervalo_repeticao }}"
            
            - variables:
                janelas_ainda_abertas: >
                  {{ expand(lista_sensores_janelas) 
                     | selectattr('state', 'eq', 'on')
                     | map(attribute='name') 
                     | list | join(', ') }}
            
            - service: !input notify_service
              data:
                title: "ğŸ” Lembrete: Janelas ainda abertas"
                message: >
                  A chuva continua! Ainda hÃ¡ {{ expand(lista_sensores_janelas) | selectattr('state', 'eq', 'on') | list | count }}
                  abertura(s): {{ janelas_ainda_abertas }}. (Lembrete {{ repeat.index }})