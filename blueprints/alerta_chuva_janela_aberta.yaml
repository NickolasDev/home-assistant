blueprint:
  name: Alerta de Janela Aberta na Chuva
  description: >
    Envia uma notificaÃ§Ã£o se comeÃ§ar a chover e qualquer uma das
    janelas ou portas monitoradas estiver aberta.
    
    A notificaÃ§Ã£o lista exatamente quais janelas estÃ£o abertas.
  domain: automation

  input:
    rain_sensor:
      name: (ObrigatÃ³rio) Sensor de Chuva
      description: A entidade (binary_sensor) que muda para 'on' quando estÃ¡ chovendo.
      selector:
        entity:
          domain: binary_sensor

    window_sensors:
      name: (ObrigatÃ³rio) Sensores de Janela/Porta
      description: Selecione todas as janelas ou portas que devem ser monitoradas.
      selector:
        entity:
          domain: binary_sensor
          device_class: 
            - door
            - window
          multiple: true
          
    notify_service:
      name: (ObrigatÃ³rio) ServiÃ§o de NotificaÃ§Ã£o
      description: >
        Selecione o serviÃ§o para enviar a notificaÃ§Ã£o 
        (ex: notify.mobile_app_seu_celular ou um grupo notify).
      selector:
        service:
          domain: notify
          
    message_title:
      name: (Opcional) TÃ­tulo da NotificaÃ§Ã£o
      description: O tÃ­tulo da mensagem de notificaÃ§Ã£o.
      default: "ğŸŒ§ï¸ ALERTA DE CHUVA! ğŸŒ§ï¸"
      selector:
        text:

    message_body:
      name: (Opcional) Corpo da Mensagem
      description: >
        O texto da notificaÃ§Ã£o. Use a variÃ¡vel '{janelas_abertas}'
        para listar as janelas.
      default: "EstÃ¡ chovendo e as seguintes janelas estÃ£o abertas: {janelas_abertas}."
      selector:
        text:

# Impede que a automaÃ§Ã£o seja disparada vÃ¡rias vezes seguidas
mode: single
max_exceeded: silent

# --- LÃ“GICA DA AUTOMAÃ‡ÃƒO ---

# VariÃ¡vel para pegar a lista de sensores do input
variables:
  lista_sensores_janelas: !input window_sensors

# GATILHO: A automaÃ§Ã£o dispara quando o sensor de chuva for ativado
trigger:
  - platform: state
    entity_id: !input rain_sensor
    to: 'on'

# CONDIÃ‡ÃƒO: A automaÃ§Ã£o SÃ“ CONTINUA se alguma das janelas estiver aberta
condition:
  - condition: template
    value_template: >
      {{ expand(lista_sensores_janelas) | selectattr('state', 'eq', 'on') | list | count > 0 }}

# AÃ‡ÃƒO: Se o gatilho e a condiÃ§Ã£o forem verdadeiros, enviar a notificaÃ§Ã£o
action:
  # 1. Criamos uma variÃ¡vel local para formatar a lista de nomes amigÃ¡veis
  - variables:
      janelas_abertas: >
        {{ expand(lista_sensores_janelas) 
           | selectattr('state', 'eq', 'on')
           | map(attribute='name') 
           | list 
           | join(', ') }}
           
  # 2. Enviamos a notificaÃ§Ã£o usando o serviÃ§o e as mensagens definidas
  - service: !input notify_service
    data:
      title: !input message_title
      message: >
        {{ !input message_body | replace('{janelas_abertas}', janelas_abertas) }}
