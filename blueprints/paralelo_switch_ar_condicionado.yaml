blueprint:
  name: Sincronizar Interruptor e Ar Condicionado (com Temp/Modo Opcional)
  description: >
    Sincroniza um interruptor (switch) com uma entidade de ar condicionado (climate).
    
    - Ligar/desligar o interruptor liga/desliga o AC.
    - Ligar/desligar o AC (pelo app, controle remoto, etc.) liga/desliga o interruptor.
    
    EVOLUÇÃO:
    - Permite definir opcionalmente um Modo HVAC (ex: 'cool') e uma Temperatura Alvo
      quando o interruptor é LIGADO.
    
    Inclui lógica para prevenir loops infinitos.
  domain: automation
  
  input:
    switch_entity:
      name: (Obrigatório) Entidade do Interruptor
      description: O interruptor (switch) que você quer sincronizar.
      selector:
        entity:
          domain: switch
          
    climate_entity:
      name: (Obrigatório) Entidade do Ar Condicionado
      description: O ar condicionado (climate) que você quer sincronizar.
      selector:
        entity:
          domain: climate

    hvac_mode_input:
      name: (Opcional) Modo do AC ao Ligar
      description: >
        Definir este modo HVAC (ex: 'cool', 'heat') quando o interruptor LIGAR.
        Se não for definido, o AC ligará no último modo usado ou usará 'climate.turn_on'.
      selector:
        select:
          options:
            - 'cool'
            - 'heat'
            - 'heat_cool'
            - 'auto'
            - 'dry'
            - 'fan_only'
          mode: dropdown
          
    target_temperature_input:
      name: (Opcional) Temperatura Alvo ao Ligar
      description: Definir esta temperatura (em °C ou °F) quando o interruptor LIGAR.
      selector:
        number:
          min: 16
          max: 30
          step: 0.5
          mode: box

# Define as variáveis com os inputs para facilitar a leitura
variables:
  switch: !input switch_entity
  climate: !input climate_entity
  hvac_mode: !input hvac_mode_input
  target_temp: !input target_temperature_input

# A automação será disparada quando QUALQUER uma das entidades mudar de estado
trigger:
  - platform: state
    entity_id: !input switch_entity
  - platform: state
    entity_id: !input climate_entity

action:
  - choose:
      # --- CASO 1: O INTERRUPTOR FOI O GATILHO ---
      - conditions:
          # Verifica se a entidade que disparou a automação foi o interruptor
          - condition: template
            value_template: "{{ trigger.entity_id == switch }}"
          # Condição Anti-Loop: Só executa se os estados estiverem dessincronizados
          - condition: template
            value_template: >
              {{ (trigger.to_state.state == 'on' and is_state(climate, 'off')) or
                 (trigger.to_state.state == 'off' and not is_state(climate, 'off')) }}
        sequence:
          # Agora, uma escolha interna para LIGAR ou DESLIGAR
          - choose:
              # --- SUB-CASO 1.1: Interruptor LIGOU ---
              - conditions:
                  - condition: template
                    value_template: "{{ trigger.to_state.state == 'on' }}"
                sequence:
                  # Lógica de "Ligar" com opções
                  - choose:
                      # Opção A: Modo HVAC foi definido (com ou sem temp)
                      - conditions:
                          - condition: template
                            value_template: "{{ hvac_mode is not none }}"
                        sequence:
                          # 1. Definir o modo (isto geralmente liga o AC)
                          - service: climate.set_hvac_mode
                            target:
                              entity_id: !input climate_entity
                            data:
                              hvac_mode: "{{ hvac_mode }}"
                          # 2. Se a temperatura também foi definida, aplicá-la
                          - if:
                              - condition: template
                                value_template: "{{ target_temp is not none }}"
                            then:
                              - service: climate.set_temperature
                                target:
                                  entity_id: !input climate_entity
                                data:
                                  temperature: "{{ target_temp }}"
                                  
                      # Opção B: Apenas Temperatura foi definida (sem modo)
                      - conditions:
                          - condition: template
                            value_template: "{{ target_temp is not none }}"
                        sequence:
                          # 1. Ligar o AC (para garantir que está ligado)
                          - service: climate.turn_on
                            target:
                              entity_id: !input climate_entity
                          # 2. Definir a temperatura
                          - service: climate.set_temperature
                            target:
                              entity_id: !input climate_entity
                            data:
                              temperature: "{{ target_temp }}"
                              
                    # Opção C (Padrão): Nem modo, nem temp foram definidos
                    default:
                      - service: climate.turn_on
                        target:
                          entity_id: !input climate_entity
              
              # --- SUB-CASO 1.2: Interruptor DESLIGOU ---
              - conditions:
                  - condition: template
                    value_template: "{{ trigger.to_state.state == 'off' }}"
                sequence:
                  - service: climate.turn_off
                    target:
                      entity_id: !input climate_entity
            default: []

      # --- CASO 2: O AR CONDICIONADO FOI O GATILHO ---
      - conditions:
          # Verifica se a entidade que disparou a automação foi o AC
          - condition: template
            value_template: "{{ trigger.entity_id == climate }}"
          # Condição Anti-Loop: Só executa se os estados estiverem dessincronizados
          - condition: template
            value_template: >
              {{ (trigger.to_state.state != 'off' and is_state(switch, 'off')) or
                 (trigger.to_state.state == 'off' and is_state(switch, 'on')) }}
        sequence:
          # Ação: Chama 'switch.turn_on' (se o AC ligou) ou 'switch.turn_off' (se o AC desligou)
          - service: "switch.turn_{{ 'on' if trigger.to_state.state != 'off' else 'off' }}"
            target:
              entity_id: !input switch_entity

    default: []